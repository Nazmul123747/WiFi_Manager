<!doctype html>
<html lang="bn">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,viewport-fit=cover">
  
  <meta name="theme-color" content="#3b5998">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  
  <title>WiFi Manager Pro Cloud</title>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  
  <style>
    /* --- SAME CSS AS BEFORE --- */
    body { background-color: #f0f2f5; margin: 0; font-family: 'Segoe UI', sans-serif; font-size: 14px; color: #333; max-width: 650px; margin: 0 auto; padding-bottom: 80px; user-select: none; -webkit-tap-highlight-color: transparent; scroll-behavior: smooth; }
    .wap-header { background-color: #3b5998; color: #fff; padding: 12px 15px; font-weight: bold; font-size: 16px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 50; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .wap-box { border: 1px solid #cbd5e1; margin: 15px 10px; background: #fff; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    .box-head { background: #3b5998; color: white; padding: 10px 15px; font-weight: bold; display:flex; justify-content:space-between; }
    .box-content { padding: 15px; }
    .wap-inp, .wap-sel { border: 1px solid #cbd5e1; padding: 8px; width: 100%; box-sizing: border-box; border-radius: 4px; height: 38px; }
    .wap-btn { background: #3b5998; color: white; border: 1px solid #1e293b; padding: 8px 12px; font-weight: bold; cursor: pointer; border-radius: 4px; }

    /* TODAY'S ACTIVITY */
    .today-card { margin: 10px; background: white; border-radius: 8px; border: 1px solid #e2e8f0; box-shadow: 0 2px 4px rgba(0,0,0,0.05); overflow: hidden; }
    .tc-head { padding: 10px 15px; border-bottom: 1px solid #f1f5f9; display: flex; justify-content: space-between; align-items: center; font-weight: bold; color: #334155; background: #f8fafc; }
    .tc-grid { display: flex; padding: 10px; gap: 10px; }
    .tc-item { flex: 1; border: 1px solid #e2e8f0; border-radius: 6px; padding: 8px 5px; text-align: center; }
    
    .dash-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1px; background: #e2e8f0; }
    .d-item { background: #fff; padding: 15px 5px; text-align: center; display: flex; flex-direction: column; justify-content: center; height: 70px; }
    .d-lbl { font-size: 11px; color: #64748b; font-weight: bold; text-transform: uppercase; margin-bottom: 5px; }
    .d-val { font-size: 18px; font-weight: 800; color: #1e293b; }

    #list { display: flex; flex-direction: column; gap: 12px; padding: 15px; }
    .client-card { background: #fff; border-radius: 10px; padding: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); border-left: 5px solid #ccc; transition: all 0.3s ease; }
    .card-paid { border-left-color: #22c55e; opacity: 0.9; } .card-due { border-left-color: #f59e0b; } 
    .card-exp { border-left-color: #ef4444; border: 2px solid #fee2e2; } .card-free { border-left-color: #06b6d4; }
    .card-header { display: flex; justify-content: space-between; margin-bottom: 10px; border-bottom: 1px dashed #eee; padding-bottom: 8px; }
    .c-name { font-size: 16px; font-weight: bold; color: #1e293b; }
    .card-body { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 13px; color: #555; }
    .prev-due-box { grid-column: span 2; background: #fef2f2; color: #dc2626; padding: 5px; border-radius: 4px; font-weight: bold; text-align: center; border: 1px dashed #fca5a5; margin-top: 5px; }
    .card-actions { display: flex; gap: 8px; margin-top: 10px; border-top: 1px solid #eee; padding-top: 10px; }
    .btn-icon { flex: 1; border: none; padding: 8px; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 12px; display:flex; align-items:center; justify-content:center; gap:5px; }
    .btn-call { background: #e0f2fe; color: #0284c7; } .btn-wa { background: #dcfce7; color: #16a34a; } .btn-edit { background: #f1f5f9; color: #475569; }
    .btn-bill { background: #eef2ff; color: #4f46e5; }
    .btn-hist { background: #fff7ed; color: #ea580c; }

    .wap-footer { position: fixed; bottom: 0; left: 0; right: 0; background: #fff; border-top: 2px solid #3b5998; padding: 10px 0; display: flex; justify-content: space-around; z-index: 100; max-width: 650px; margin: 0 auto; }
    .f-item { color: #64748b; text-decoration: none; font-weight: bold; font-size: 11px; display:flex; flex-direction:column; align-items:center; }
    .f-item.active { color: #3b5998; }
    .modal-ov { position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center; z-index: 200; }
    .modal-box { background: white; padding: 20px; border-radius: 8px; width: 90%; max-width: 400px; max-height: 80vh; overflow-y: auto; }
    
    #syncStatus { font-size: 11px; color: white; background: rgba(255,255,255,0.2); padding: 2px 8px; border-radius: 10px; margin-left: 10px; display: inline-block; transition: background 0.3s; }
    .scroll-btns { position: fixed; bottom: 85px; right: 15px; display: flex; flex-direction: column; gap: 10px; z-index: 99; }
    .s-btn { background: rgba(59, 89, 152, 0.85); color: white; border: none; padding: 0; width: 40px; height: 40px; border-radius: 50%; box-shadow: 0 4px 6px rgba(0,0,0,0.2); cursor: pointer; font-size: 18px; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(2px); }

    .chart-container { position: relative; height: 200px; width: 100%; margin-top: 10px; display:flex; justify-content:center; }
    .data-table { width: 100%; border-collapse: collapse; font-size: 12px; }
    .data-table th, .data-table td { border: 1px solid #eee; padding: 6px; text-align: left; }
    .data-table th { background: #f8fafc; color: #3b5998; }

    /* Security Overlay */
    #lockScreen { position: fixed; inset: 0; background: #3b5998; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; }

    @media print {
        .wap-header, .wap-box, .today-card, .scroll-btns, .wap-footer, .modal-ov, .dash-grid, #filterArea, #list { display: none !important; }
        body { background: #fff !important; margin: 0 !important; padding: 0 !important; height: auto !important; overflow: visible !important; }
        #invoiceArea { display: block !important; position: absolute !important; left: 0 !important; top: 0 !important; width: 100% !important; margin: 0 !important; padding: 20px !important; background: white !important; z-index: 9999 !important; }
        #invoiceArea * { visibility: visible !important; color: #000 !important; }
    }
  </style>
</head>
<body>

  <div id="lockScreen">
      <div style="font-size:24px; font-weight:bold; margin-bottom:20px;"><i class="fas fa-lock"></i> Security Check</div>
      <input type="password" id="pinInput" placeholder="Enter PIN" style="padding:10px; border-radius:5px; border:none; text-align:center; font-size:18px; width:150px;">
      <button onclick="checkPin()" style="margin-top:15px; padding:8px 20px; background:white; color:#3b5998; border:none; border-radius:5px; font-weight:bold; cursor:pointer;">Unlock</button>
  </div>

  <div class="wap-header">
    <div style="display:flex; align-items:center;">
        <i class="fas fa-wifi"></i> &nbsp; WiFi Manager
        <span id="syncStatus"><i class="fas fa-circle-notch fa-spin"></i> Checking...</span>
    </div>
    <div style="display:flex; gap:10px;">
        <div style="cursor: pointer; font-size:16px;" onclick="openSettings()"><i class="fas fa-cog"></i></div>
        <div style="cursor: pointer; font-size:13px; background:rgba(255,255,255,0.2); padding:4px 8px; border-radius:4px;" onclick="forceSave()">
        <i class="fas fa-sync-alt"></i> Sync
        </div>
    </div>
  </div>

  <div class="wap-box">
    <div class="box-head" style="justify-content:center;">Select Month</div>
    <div style="display: flex; gap: 5px; justify-content: center; align-items: center; background: #f8fafc; padding: 10px;">
      <input type="month" id="monthInput" onchange="handleMonthChange(this.value)" class="wap-inp" style="width:auto;">
      <button class="wap-btn" style="background:#16a34a;" onclick="exportExcel()"><i class="fas fa-file-excel"></i></button>
      <button class="wap-btn" style="background:#dc2626;" onclick="archiveAndReset()">End</button>
    </div>
    <div id="viewStatus" style="text-align:center; padding:5px; font-size:12px; font-weight:bold; color:#16a34a; background:#f0fdf4; border-top:1px solid #e2e8f0;">
        ‚ö° Live Data (Auto Sync On)
    </div>
  </div>

  <div class="today-card">
    <div class="tc-head">
      <span><i class="fas fa-calendar-check" style="color:#3b5998; margin-right:5px;"></i> TODAY'S ACTIVITY</span>
      <span style="font-size:11px; font-weight:bold; color:#64748b;" id="todayDate"></span>
    </div>
    <div class="tc-grid">
      <div class="tc-item" style="border-color:#bbf7d0; background:#f0fdf4">
        <span style="font-size:11px; color:#16a34a; font-weight:bold;">Collected</span>
        <div style="font-weight:bold; font-size:16px; color:#16a34a" id="tColl">0</div>
      </div>
      <div class="tc-item" style="border-color:#fecaca; background:#fef2f2">
        <span style="font-size:11px; color:#dc2626; font-weight:bold;">Expense</span>
        <div style="font-weight:bold; font-size:16px; color:#dc2626" id="tExp">0</div>
      </div>
      <div class="tc-item" style="border-color:#bae6fd; background:#f0f9ff">
        <span style="font-size:11px; color:#0284c7; font-weight:bold;">Profit</span>
        <div style="font-weight:bold; font-size:16px; color:#0284c7" id="tNet">0</div>
      </div>
    </div>
  </div>

  <div class="wap-box">
    <div class="box-head">Dashboard Overview</div>
    <div class="dash-grid">
      <div class="d-item"><div class="d-lbl">Active (All)</div><div class="d-val" id="vAct">0</div></div>
      <div class="d-item"><div class="d-lbl">Paid User</div><div class="d-val" style="color:#16a34a" id="vPaid">0</div></div>
      <div class="d-item"><div class="d-lbl">Unpaid User</div><div class="d-val" style="color:#f59e0b" id="vUnpaid">0</div></div>
      
      <div class="d-item"><div class="d-lbl">Current Due</div><div class="d-val" style="color:#d97706" id="vCurrDue">0</div></div>
      <div class="d-item"><div class="d-lbl">Prev. Due</div><div class="d-val" style="color:#dc2626" id="vPrevDueTotal">0</div></div>
      <div class="d-item"><div class="d-lbl">Collected</div><div class="d-val" style="color:#3b5998" id="vColl">0</div></div>
      
      <div class="d-item"><div class="d-lbl">Expired</div><div class="d-val" style="color:#ef4444" id="vExp">0</div></div>
      <div class="d-item" onclick="openExpModal()"><div class="d-lbl" style="text-decoration:underline; cursor:pointer; color:#ef4444;">Total Exp.</div><div class="d-val" style="color:#ef4444" id="vExpense">0</div></div>
      <div class="d-item"><div class="d-lbl">Net Profit</div><div class="d-val" style="color:#16a34a" id="vNet">0</div></div>
    </div>
    
    <div style="padding:10px; background:#f8fafc; border-top:1px solid #eee;">
        <div style="font-size:12px; font-weight:bold; color:#64748b; margin-bottom:5px; text-align:center;">Analytics</div>
        <div style="display:flex; gap:10px;">
            <div class="chart-container" style="flex:1;"><canvas id="statusChart"></canvas></div>
            <div class="chart-container" style="flex:1;"><canvas id="financeChart"></canvas></div>
        </div>
    </div>
  </div>

  <div class="wap-box" style="position: sticky; top: 50px; z-index: 40; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);">
    <div class="box-content" style="padding-bottom:5px;">
        <select id="filterArea" class="wap-sel" style="background:#f1f5f9; font-weight:bold; color:#3b5998;" onchange="render()">
            <option value="all">üìç All Areas (‡¶∏‡¶¨ ‡¶è‡¶≤‡¶æ‡¶ï‡¶æ)</option>
            <option value="Boiddonat">Boiddonat</option>
            <option value="Fotekha">Fotekha</option>
            <option value="Sorkar tari">Sorkar tari</option>
            <option value="Chaitantola">Chaitantola</option>
            <option value="Khamar">Khamar</option>
            <option value="hobiyar dokan">hobiyar dokan</option>
            <option value="Master er mor">Master er mor</option>
        </select>
    </div>
    <div class="box-content" style="display:flex; gap:8px; padding-top:0;">
      <input id="search" class="wap-inp" placeholder="Search..." style="flex:1; border: 2px solid #3b5998;" oninput="render()">
      <button class="wap-btn" style="background:#25D366; color:#fff;" onclick="openBulkModal()"><i class="fab fa-whatsapp"></i> List</button>
      <button class="wap-btn" onclick="openModal()"><i class="fas fa-plus"></i></button>
    </div>
  </div>

  <div class="wap-box">
    <div class="box-head">Client List</div>
    <div id="list"></div>
  </div>

  <div class="scroll-btns">
    <button class="s-btn" onclick="window.scrollTo(0,0)"><i class="fas fa-arrow-up"></i></button>
    <button class="s-btn" onclick="window.scrollTo(0, document.body.scrollHeight)"><i class="fas fa-arrow-down"></i></button>
  </div>

  <div style="height: 80px;"></div>

  <div class="wap-footer">
    <a href="#" class="f-item active" onclick="setFilter('all')"><i class="fas fa-users"></i> All</a>
    <a href="#" class="f-item" onclick="setFilter('paid')"><i class="fas fa-check-circle"></i> Paid</a>
    <a href="#" class="f-item" onclick="setFilter('unpaid')"><i class="fas fa-exclamation-circle"></i> Unpaid</a>
    <a href="#" class="f-item" onclick="setFilter('due')"><i class="fas fa-hand-holding-usd"></i> Due</a>
    <a href="#" class="f-item" onclick="openExpModal()"><i class="fas fa-receipt"></i> Exp</a>
  </div>

  <div class="modal-ov" id="settingsOv">
    <div class="modal-box">
      <h3 style="margin-top:0; color:#3b5998;">‚öôÔ∏è Settings <i class="fas fa-times" onclick="$('settingsOv').style.display='none'" style="float:right;cursor:pointer;color:#333;"></i></h3>
      <div style="margin-bottom:20px; border-bottom:1px solid #eee; padding-bottom:15px;">
        <div style="font-weight:bold; margin-bottom:5px;">Change PIN</div>
        <div style="display:flex; gap:5px;">
            <input id="newPin" class="wap-inp" placeholder="New PIN (e.g. 1234)">
            <button class="wap-btn" onclick="changePin()">Save</button>
        </div>
      </div>
      <div style="margin-bottom:10px;">
        <div style="font-weight:bold; margin-bottom:5px;">Data Backup & Restore</div>
        <button class="wap-btn" style="width:100%; margin-bottom:10px; background:#0284c7;" onclick="backupData()"><i class="fas fa-download"></i> Download Backup File</button>
        <input type="file" id="restoreFile" style="display:none" onchange="restoreData(this)">
        <button class="wap-btn" style="width:100%; background:#f59e0b;" onclick="$('restoreFile').click()"><i class="fas fa-upload"></i> Restore Backup File</button>
        <small style="color:#666; display:block; margin-top:5px;">*Restoring will replace all current data.</small>
      </div>
    </div>
  </div>

  <div class="modal-ov" id="modalOv">
    <div class="modal-box">
      <h3 style="margin-top:0; color:#3b5998;">Client Details</h3>
      <input type="hidden" id="m_id">
      <input id="m_name" class="wap-inp" placeholder="Name" style="margin-bottom:8px;">
      <select id="m_area" class="wap-sel" style="margin-bottom:8px; border-color:#3b5998;">
          <option value="">-- Select Area --</option>
          <option value="Boiddonat">Boiddonat</option>
          <option value="Fotekha">Fotekha</option>
          <option value="Sorkar tari">Sorkar tari</option>
          <option value="Chaitantola">Chaitantola</option>
          <option value="Khamar">Khamar</option>
          <option value="hobiyar dokan">hobiyar dokan</option>
          <option value="Master er mor">Master er mor</option>
      </select>
      <input id="m_user" class="wap-inp" placeholder="User ID" style="margin-bottom:8px;">
      <input id="m_mob" class="wap-inp" type="tel" placeholder="Mobile" style="margin-bottom:8px;">
      <div style="display:flex; gap:10px; margin-bottom:8px;">
        <select id="m_pkg" class="wap-sel" onchange="setBill()">
            <option value="5Mbps">5Mbps</option><option value="10Mbps">10Mbps</option>
            <option value="12Mbps">12Mbps</option><option value="20Mbps">20Mbps</option>
        </select>
        <input id="m_bill" type="number" class="wap-inp" placeholder="Bill">
      </div>
      <label style="font-size:12px; font-weight:bold; color:#666;">Expire Date:</label>
      <input id="m_expDate" type="date" class="wap-inp" style="margin-bottom:8px; border:2px solid #ef4444;">
      <input id="m_prevDue" type="number" class="wap-inp" placeholder="Previous Due" style="margin-bottom:15px; border-color:#fca5a5;">
      <div style="display:flex; gap:10px;">
        <button class="wap-btn" style="flex:1; background:#64748b;" onclick="$('modalOv').style.display='none'">Cancel</button>
        <button class="wap-btn" style="flex:1;" onclick="saveUser()">Save</button>
      </div>
    </div>
  </div>

  <div class="modal-ov" id="expOv">
    <div class="modal-box">
      <h3 style="margin-top:0; color:#ef4444;">Expenses <i class="fas fa-times" onclick="$('expOv').style.display='none'" style="float:right;cursor:pointer;color:#333;"></i></h3>
      <input id="ex_reason" class="wap-inp" placeholder="Reason" style="margin-bottom:8px;">
      <input id="ex_amount" type="number" class="wap-inp" placeholder="Amount" style="margin-bottom:8px;">
      <button class="wap-btn" onclick="saveExpense()" style="width:100%; background:#ef4444;">Add</button>
      <div id="expList" style="max-height:200px; overflow-y:auto; margin-top:10px;"></div>
    </div>
  </div>

  <div class="modal-ov" id="historyOv">
    <div class="modal-box">
      <h3 style="margin-top:0; color:#ea580c;">Payment History <i class="fas fa-times" onclick="$('historyOv').style.display='none'" style="float:right;cursor:pointer;color:#333;"></i></h3>
      <div id="historyName" style="font-weight:bold; margin-bottom:10px; color:#555;"></div>
      <div style="max-height:300px; overflow-y:auto;">
          <table class="data-table">
              <thead><tr><th>Month</th><th>Bill</th><th>Due</th><th>Status</th></tr></thead>
              <tbody id="historyList"></tbody>
          </table>
      </div>
    </div>
  </div>

  <div class="modal-ov" id="bulkOv">
    <div class="modal-box">
      <h3 style="margin-top:0; color:#25D366;">Due List (Send SMS) <i class="fas fa-times" onclick="$('bulkOv').style.display='none'" style="float:right;cursor:pointer;color:#333;"></i></h3>
      <div style="font-size:12px; margin-bottom:10px; color:#666;">Click "Send" to open WhatsApp for each user.</div>
      <div style="max-height:300px; overflow-y:auto;">
          <table class="data-table">
              <thead><tr><th>Name</th><th>Due</th><th>Action</th></tr></thead>
              <tbody id="bulkList"></tbody>
          </table>
      </div>
    </div>
  </div>

  <div id="invoiceArea" style="display:none; text-align:center; padding:20px; font-family:'Segoe UI',sans-serif;">
      <h2 style="margin:0; color:#3b5998;">WIFI MANAGER</h2>
      <p style="margin:5px 0; font-size:12px;">Internet Service Bill</p>
      <hr style="border:1px dashed #ccc; margin:10px 0;">
      <div style="text-align:left; font-size:14px; line-height:1.6; margin-bottom:15px;">
          <strong>Name:</strong> <span id="inv_name"></span><br>
          <strong>User ID:</strong> <span id="inv_id"></span><br>
          <strong>Mobile:</strong> <span id="inv_mob"></span><br>
          <strong>Area:</strong> <span id="inv_area"></span><br>
          <strong>Package:</strong> <span id="inv_pkg"></span><br>
          <strong>Date:</strong> <span id="inv_date"></span>
      </div>
      <table style="width:100%; border-collapse:collapse; border:1px solid #000;">
          <tr style="background:#eee;">
              <th style="border:1px solid #000; padding:5px;">Description</th>
              <th style="border:1px solid #000; padding:5px; text-align:right;">Amount</th>
          </tr>
          <tr>
              <td style="border:1px solid #000; padding:5px;">Monthly Bill</td>
              <td style="border:1px solid #000; padding:5px; text-align:right;"><span id="inv_bill"></span></td>
          </tr>
          <tr>
              <td style="border:1px solid #000; padding:5px;">Previous Due</td>
              <td style="border:1px solid #000; padding:5px; text-align:right;"><span id="inv_prev"></span></td>
          </tr>
          <tr style="font-weight:bold; background:#f9f9f9;">
              <td style="border:1px solid #000; padding:5px;">Total Payable</td>
              <td style="border:1px solid #000; padding:5px; text-align:right;"><span id="inv_total"></span></td>
          </tr>
      </table>
      <div style="margin-top:30px; border-top:1px solid #000; width:120px; text-align:center; float:right;">Signature</div>
      <div style="clear:both;"></div>
      <div style="margin-top:20px; font-size:12px;">Thank you!</div>
  </div>

<script>
  // ================= CONFIG & INIT =================
  const DB_KEY = 'wifi_local_cache'; 
  const QUEUE_KEY = 'wifi_sync_queue';
  const SUPABASE_URL = 'https://afybenuinfrszbudovvw.supabase.co';
  const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFmeWJlbnVpbmZyc3pidWRvdnZ3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQzNDkwMTYsImV4cCI6MjA3OTkyNTAxNn0.cxtcvmXvVMPy-hhLq2NNk5T_3K-kZJBUCaBAgG3my9g';
  const PIN_KEY = 'wifi_pin_v1';
  const SESSION_KEY = 'wifi_session_ts';
  const SESSION_TIME = 5 * 60 * 1000; // 5 Minutes

  const $ = id => document.getElementById(id);
  const pkgRates = {"5Mbps":300, "10Mbps":400, "12Mbps":500, "20Mbps":800};
  let currentFilter = 'all';
  let users = [], expenses = [], archives = [];
  let viewMode = false;
  let currentActiveMonthStr = "";
  let stChart = null, fnChart = null;

  const getTodayStr = () => new Date().toISOString().split('T')[0];

  // --- SMART SECURITY PIN CHECK ---
  function checkSession() {
      const lastLogin = localStorage.getItem(SESSION_KEY);
      if (lastLogin && (Date.now() - lastLogin < SESSION_TIME)) {
          $('lockScreen').style.display = 'none'; // Auto unlock if valid
      } else {
          $('lockScreen').style.display = 'flex'; // Show lock
      }
  }

  function checkPin() {
      const pin = localStorage.getItem(PIN_KEY) || "1234";
      const inp = $('pinInput').value;
      if(inp === pin) {
          localStorage.setItem(SESSION_KEY, Date.now()); // Set Session
          $('lockScreen').style.display = 'none';
      } else {
          alert("Wrong PIN! Try again.");
          $('pinInput').value = '';
      }
  }

  function openSettings() { $('settingsOv').style.display = 'flex'; }
  function changePin() {
      const newP = $('newPin').value;
      if(newP && newP.length >= 4) {
          localStorage.setItem(PIN_KEY, newP); alert("PIN Changed!"); $('newPin').value = '';
      } else { alert("Enter at least 4 digits"); }
  }

  // --- BACKUP & RESTORE ---
  function backupData() {
      const data = { users, expenses, archives };
      const blob = new Blob([JSON.stringify(data)], {type: "application/json"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = "WiFi_Backup_" + getTodayStr() + ".json"; a.click();
  }
  function restoreData(input) {
      const file = input.files[0]; if(!file) return;
      const reader = new FileReader();
      reader.onload = function(e) {
          try {
              const d = JSON.parse(e.target.result);
              if(d.users) { users = d.users; expenses = d.expenses || []; archives = d.archives || []; saveData(); alert("Data Restored!"); location.reload(); } 
              else { alert("Invalid File"); }
          } catch(err) { alert("Error reading file"); }
      }; reader.readAsText(file);
  }

  async function sbFetch(path, options = {}) {
    const url = `${SUPABASE_URL}/rest/v1/${path}`;
    const headers = { apikey: SUPABASE_KEY, Authorization: `Bearer ${SUPABASE_KEY}`, 'Content-Type': 'application/json', Prefer: 'return=representation' };
    const res = await fetch(url, { ...options, headers: { ...headers, ...(options.headers || {}) } });
    if (!res.ok) throw new Error(`${res.status}`);
    return res.status === 204 ? null : res.json();
  }

  function getQueue() { try { return JSON.parse(localStorage.getItem(QUEUE_KEY) || '[]'); } catch { return []; } }
  function setQueue(q) { localStorage.setItem(QUEUE_KEY, JSON.stringify(q)); }
  function enqueue(op) { const q = getQueue(); q.push({ ...op, ts: Date.now() }); setQueue(q); updateStatus('Pending Sync...', true); }
  
  async function flushSyncQueue() {
    const q = getQueue(); if (q.length === 0) return;
    updateStatus(`Syncing ${q.length} items...`, true);
    let successCount = 0; const failedOps = [];
    for (const op of q) {
      try {
        if (op.type === 'upsertUser') await sbFetch('users', { method: 'POST', body: JSON.stringify({ ...op.data, updated_at: new Date().toISOString() }), headers: { 'Prefer': 'resolution=merge-duplicates' } });
        else if (op.type === 'updateUser') await sbFetch(`users?id=eq.${encodeURIComponent(op.id)}`, { method: 'PATCH', body: JSON.stringify({ ...op.data, updated_at: new Date().toISOString() }) });
        else if (op.type === 'upsertExpense') await sbFetch('expenses', { method: 'POST', body: JSON.stringify({ ...op.data, updated_at: new Date().toISOString() }), headers: { 'Prefer': 'resolution=merge-duplicates' } });
        else if (op.type === 'deleteExpense') await sbFetch(`expenses?id=eq.${encodeURIComponent(op.id)}`, { method: 'DELETE' });
        else if (op.type === 'upsertArchive') await sbFetch('archives', { method: 'POST', body: JSON.stringify(op.data) });
        successCount++;
      } catch (e) { failedOps.push(op); }
    }
    setQueue(failedOps);
    if (failedOps.length === 0) updateStatus('Synced', false);
    else updateStatus(`Synced ${successCount}, Pending ${failedOps.length}`, false);
  }

  function init() {
    checkSession(); // CHECK LOCK SCREEN FIRST
    const now = new Date();
    currentActiveMonthStr = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
    $('monthInput').value = currentActiveMonthStr;
    $('todayDate').innerText = now.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
    loadFromLocal(); render(); setTimeout(fetchData, 1500); 
  }

  function loadFromLocal() {
      const local = localStorage.getItem(DB_KEY);
      if(local) { const d = JSON.parse(local); users = d.users || []; expenses = d.expenses || []; archives = d.archives || []; } 
      else if(!localStorage.getItem('first_run_done_v2')) localStorage.setItem('first_run_done_v2', 'true');
  }

  async function fetchData() {
    if (getQueue().length > 0) { await flushSyncQueue(); if (getQueue().length > 0) { updateStatus('Offline (Queue Active)', false); return; } }
    updateStatus('Syncing...', true);
    try {
      const [remoteUsers, remoteExpenses, remoteArchives] = await Promise.all([ sbFetch('users?select=*'), sbFetch('expenses?select=*'), sbFetch('archives?select=*') ]);
      if (remoteUsers) {
             const rMap = new Map(remoteUsers.map(r => [String(r.id), r]));
             users = users.map(u => { const r = rMap.get(u.id); return r ? { ...u, conn: r.conn, pay: r.pay, due: r.due, prevDue: r.prev_due, expDate: r.exp_date || u.expDate, bill: r.bill, area: r.area || u.area } : u; });
             remoteUsers.forEach(r => { if(!users.find(u => u.id == r.id)) users.push({ id: String(r.id), name: r.name, user: r.user_id, pkg: r.pkg, mob: r.mob, bill: Number(r.bill), conn: r.conn, pay: r.pay, due: Number(r.due), prevDue: Number(r.prev_due), expDate: r.exp_date, area: r.area }); });
      }
      if (remoteExpenses) expenses = remoteExpenses.map(r => ({ id: String(r.id), desc: r.desc, amnt: Number(r.amnt) || 0, date: r.date || null }));
      if (remoteArchives) archives = remoteArchives.map(r => ({ id: String(r.id), name: r.name, data: r.data }));
      localStorage.setItem(DB_KEY, JSON.stringify({ users, expenses, archives }));
      render(); updateStatus('Online', false);
    } catch (e) { updateStatus('Offline Mode', false); }
  }

  function saveData(silent = false) {
    localStorage.setItem(DB_KEY, JSON.stringify({ users, expenses, archives }));
    if(!silent) render();
    if(navigator.onLine) flushSyncQueue();
  }

  function updateStatus(msg, spin) {
      const el = $('syncStatus'); el.style.display = 'inline-block';
      el.innerHTML = spin ? `<i class="fas fa-circle-notch fa-spin"></i> ${msg}` : `<i class="fas fa-check"></i> ${msg}`;
      el.style.background = (msg.includes('Offline') || msg.includes('Pending')) ? '#dc2626' : 'rgba(255,255,255,0.2)';
  }

  async function forceSave() { updateStatus('Saving...', true); saveData(true); await flushSyncQueue(); await fetchData(); }

  // --- CORE LOGIC ---
  function updPay(id, v) { 
      if(viewMode) return; const u = users.find(x=>x.id==id); u.pay = v; 
      if(v === 'Paid') { u.conn = 'Active'; u.payDate = getTodayStr(); const d = new Date(); d.setMonth(d.getMonth() + 1); d.setDate(4); u.expDate = d.toISOString().split('T')[0]; } 
      else { u.payDate = null; u.conn = u.conn === 'Free' ? 'Free' : 'Active'; }
      enqueue({ type: 'updateUser', id, data: { pay: u.pay, conn: u.conn, pay_date: u.payDate, exp_date: u.expDate } }); saveData(); 
  }
  function updConn(id, v) { if(viewMode) return; const u = users.find(x=>x.id==id); u.conn = v; enqueue({ type: 'updateUser', id, data: { conn: v } }); saveData(); }
  function updDue(id, v) { if(viewMode) return; const u = users.find(x=>x.id==id); u.due = Number(v); enqueue({ type: 'updateUser', id, data: { due: u.due } }); saveData(); }

  function render() {
    const list = $('list'); const term = ($('search').value || '').toLowerCase(); const filterArea = $('filterArea').value;
    list.innerHTML = '';
    
    let st = {act:0, paid:0, unpaid:0, exp:0, free:0, coll:0, totalDue:0, prevDueTotal:0};
    let tColl=0, tExp=0; const todayStr = getTodayStr();
    
    const sorted = [...users].sort((a,b) => {
        const w = u => (u.conn==='Active'&&u.pay==='Unpaid')?4 : (u.due>0)?3 : (u.prevDue>0)?2 : (u.conn==='Expired')?1 : 0;
        return (w(b) - w(a)) || a.name.localeCompare(b.name);
    });

    sorted.forEach(u => {
      if(filterArea !== 'all' && u.area !== filterArea) return;
      const bill = Number(u.bill)||0, due = Number(u.due)||0, prev = Number(u.prevDue)||0;
      let collected = 0;

      if(u.conn === 'Free') { st.free++; st.act++; } 
      else if(u.conn === 'Expired') { st.exp++; st.prevDueTotal += prev; } 
      else {
          st.act++; st.totalDue += due; st.prevDueTotal += prev;
          if(u.pay === 'Paid') st.paid++; else st.unpaid++;
          if(due > 0) collected = bill - due; else if(u.pay === 'Paid') collected = bill;
          st.coll += collected; if(u.payDate === todayStr) tColl += collected;
      }

      const searchText = (u.name + u.mob + u.user + u.id + (u.area||'')).toLowerCase();
      if(!searchText.includes(term)) return;
      if(currentFilter === 'paid' && (u.conn !== 'Active' || u.pay !== 'Paid')) return;
      if(currentFilter === 'unpaid' && (u.conn !== 'Active' || u.pay !== 'Unpaid')) return;
      if(currentFilter === 'due' && u.due <= 0 && u.prevDue <= 0) return;

      let cardClass = 'client-card', badge = '';
      if(u.conn === 'Free') { cardClass += ' card-free'; badge = '<span style="background:#ccfbf1; color:#0f766e; padding:2px 8px; border-radius:10px; font-size:10px; font-weight:bold;">Free</span>'; }
      else if(u.conn === 'Expired') { cardClass += ' card-exp'; badge = '<span style="background:#fee2e2; color:#b91c1c; padding:2px 8px; border-radius:10px; font-size:10px; font-weight:bold;">Expired</span>'; }
      else if(u.pay === 'Paid') { cardClass += ' card-paid'; badge = due > 0 ? '<span style="background:#fef3c7; color:#b45309; padding:2px 8px; border-radius:10px; font-size:10px; font-weight:bold;">Partial Paid</span>' : '<span style="background:#dcfce7; color:#15803d; padding:2px 8px; border-radius:10px; font-size:10px; font-weight:bold;">Paid Full</span>'; }
      else { cardClass += ' card-due'; badge = '<span style="background:#fef3c7; color:#b45309; padding:2px 8px; border-radius:10px; font-size:10px; font-weight:bold;">Due Bill</span>'; }

      const controls = viewMode ? '' : `
        <div style="background:#f8fafc; padding:8px; border-radius:6px; display:flex; gap:5px; margin-bottom:10px; align-items:center;">
            <select class="wap-sel" style="flex:1; height:32px; padding:0 5px;" onchange="updConn('${u.id}', this.value)">
                <option ${u.conn==='Active'?'selected':''}>Active</option>
                <option ${u.conn==='Expired'?'selected':''}>Expired</option>
                <option ${u.conn==='Free'?'selected':''}>Free</option>
            </select>
            ${u.conn === 'Active' ? `
            <select class="wap-sel" style="flex:1; height:32px; padding:0 5px;" onchange="updPay('${u.id}', this.value)">
                <option ${u.pay==='Unpaid'?'selected':''}>Unpaid</option>
                <option ${u.pay==='Paid'?'selected':''}>Paid</option>
            </select>
            <input class="wap-inp" type="number" value="${u.due}" onchange="updDue('${u.id}',this.value)" placeholder="Due" style="width:50px; height:32px; padding:0 5px; text-align:center; color:red; font-weight:bold;">
            ` : ''}
        </div>`;

      const prevDueHtml = u.prevDue > 0 ? `<div class="prev-due-box">‚ö†Ô∏è ‡¶Ü‡¶ó‡ßá‡¶∞ ‡¶¨‡¶æ‡¶ï‡¶ø: ${u.prevDue}‡ß≥</div>` : '';
      const areaBadge = u.area ? `<span style="font-size:11px; color:#3b5998; background:#e0f2fe; padding:2px 5px; border-radius:4px; margin-left:5px;">${u.area}</span>` : '';
      const expDateHtml = u.expDate ? `<div style="color:#666; font-size:12px; margin-top:5px; padding-top:2px; border-top:1px dashed #ddd;"><i class="fas fa-calendar-alt" style="color:#ef4444;"></i> Exp: <b>${u.expDate}</b></div>` : '';

      list.insertAdjacentHTML('beforeend', `
      <div class="${cardClass}">
        <div class="card-header">
            <div><div class="c-name">${u.name} ${u.prevDue>0?'<span style="color:red;font-size:11px;">(‡¶¨‡¶æ‡¶ï‡¶ø)</span>':''}</div><small style="color:#666">${u.user} ${areaBadge}</small></div>
            ${badge}
        </div>
        <div class="card-body">
            <div><i class="fas fa-box"></i> ${u.pkg}</div><div><i class="fas fa-phone"></i> ${u.mob}</div>
            <div style="grid-column: span 2;"><i class="fas fa-file-invoice"></i> Bill: ${u.bill}‡ß≥ | Due: <b style="color:${u.due>0?'red':'green'}">${u.due}‡ß≥</b></div>
            <div style="grid-column: span 2;">${expDateHtml}</div>
            ${prevDueHtml}
        </div>
        ${controls}
        <div class="card-actions">
            <button class="btn-icon btn-call" onclick="window.location.href='tel:${u.mob}'"><i class="fas fa-phone"></i></button>
            <button class="btn-icon btn-wa" onclick="wa('${u.mob}', '${u.pay}', ${u.due}, ${u.prevDue})"><i class="fab fa-whatsapp"></i></button>
            <button class="btn-icon btn-bill" onclick="printInvoice('${u.id}')"><i class="fas fa-print"></i></button>
            <button class="btn-icon btn-hist" onclick="openHistory('${u.id}')"><i class="fas fa-history"></i></button>
            <button class="btn-icon btn-edit" onclick="edit('${u.id}')"><i class="fas fa-edit"></i></button>
        </div>
      </div>`);
    });

    const expenseTotal = expenses.reduce((a,b)=>a+(Number(b.amnt)||0),0);
    tExp = expenses.filter(e => e.date && e.date === getTodayStr()).reduce((a,b)=>a+(Number(b.amnt)||0),0);

    $('vAct').innerText = st.act; $('vPaid').innerText = st.paid; $('vUnpaid').innerText = st.unpaid; 
    $('vExp').innerText = st.exp; $('vCurrDue').innerText = st.totalDue + '‡ß≥'; 
    $('vPrevDueTotal').innerText = st.prevDueTotal + '‡ß≥'; $('vColl').innerText = st.coll + '‡ß≥';
    $('vExpense').innerText = expenseTotal + '‡ß≥'; $('vNet').innerText = (st.coll - expenseTotal) + '‡ß≥';
    $('tColl').innerText = tColl; $('tExp').innerText = tExp; $('tNet').innerText = (tColl - tExp);

    renderCharts(st.paid, st.unpaid, st.free, st.coll, expenseTotal);
  }

  function openHistory(id) {
      const u = users.find(x => x.id == id);
      $('historyName').innerText = u.name + " (" + u.user + ")";
      const tbody = $('historyList'); tbody.innerHTML = '';
      let rows = `<tr><td>Current</td><td>${u.bill}</td><td style="color:${u.due>0?'red':'green'}">${u.due}</td><td>${u.conn}</td></tr>`;
      archives.slice().reverse().forEach(arc => {
          const oldU = arc.data.users.find(x => x.id == id);
          if (oldU) {
              const paySt = oldU.due > 0 ? 'Due' : (oldU.pay === 'Paid' ? 'Paid' : 'Unpaid');
              rows += `<tr><td>${arc.name}</td><td>${oldU.bill}</td><td style="color:${oldU.due>0?'red':'green'}">${oldU.due}</td><td>${paySt}</td></tr>`;
          }
      });
      tbody.innerHTML = rows;
      $('historyOv').style.display = 'flex';
  }

  function exportExcel() {
      const data = users.map(u => ({ Name: u.name, UserID: u.user, Mobile: u.mob, Area: u.area, Package: u.pkg, Bill: u.bill, Paid: (u.pay==='Paid'?'Yes':'No'), Due: u.due, PrevDue: u.prevDue, TotalDue: (Number(u.due)+Number(u.prevDue)) }));
      const ws = XLSX.utils.json_to_sheet(data); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "WiFi Clients"); XLSX.writeFile(wb, "WiFi_Manager_Report.xlsx");
  }

  function openBulkModal() {
      const tbody = $('bulkList'); tbody.innerHTML = '';
      const dues = users.filter(u => (u.due > 0 || u.prevDue > 0) && u.conn !== 'Free');
      if(dues.length === 0) tbody.innerHTML = '<tr><td colspan="3">No Dues Found</td></tr>';
      dues.forEach(u => {
          const total = Number(u.due) + Number(u.prevDue);
          let n = u.mob.replace(/\D/g,''); if(n.length<=11) n='88'+n;
          const msg = `‡¶™‡ßç‡¶∞‡¶ø‡ßü ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ${u.name}, ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶á‡¶®‡ßç‡¶ü‡¶æ‡¶∞‡¶®‡ßá‡¶ü ‡¶¨‡¶ø‡¶≤ ‡¶¨‡¶æ‡¶¨‡¶¶ ‡¶Æ‡ßã‡¶ü ${total} ‡¶ü‡¶æ‡¶ï‡¶æ ‡¶¨‡¶ï‡ßá‡ßü‡¶æ ‡¶Ü‡¶õ‡ßá‡•§ ‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶™‡¶∞‡¶ø‡¶∂‡ßã‡¶ß ‡¶ï‡¶∞‡ßÅ‡¶®‡•§ ‡¶ß‡¶®‡ßç‡¶Ø‡¶¨‡¶æ‡¶¶‡•§`;
          const link = `https://wa.me/${n}?text=${encodeURIComponent(msg)}`;
          tbody.innerHTML += `<tr><td>${u.name}<br><small>${u.user}</small></td><td style="color:red; font-weight:bold;">${total}</td><td><a href="${link}" target="_blank" style="text-decoration:none; background:#25D366; color:white; padding:4px 8px; border-radius:4px; font-size:11px;">Send</a></td></tr>`;
      });
      $('bulkOv').style.display = 'flex';
  }

  function renderCharts(paid, unpaid, free, coll, exp) {
    if (stChart) stChart.destroy(); if (fnChart) fnChart.destroy();
    stChart = new Chart($('statusChart'), { type: 'doughnut', data: { labels: ['Paid', 'Unpaid', 'Free'], datasets: [{ data: [paid, unpaid, free], backgroundColor: ['#16a34a', '#f59e0b', '#06b6d4'], borderWidth: 0 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } } });
    fnChart = new Chart($('financeChart'), { type: 'bar', data: { labels: ['Income', 'Expense'], datasets: [{ label: 'Amount', data: [coll, exp], backgroundColor: ['#3b5998', '#ef4444'] }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } } });
  }

  function wa(mob, pay, due, prev) { 
      let n=mob.replace(/\D/g,''); if(n.length<=11) n='88'+n; 
      let msg = ""; if(prev > 0) msg += `‡¶ó‡¶§ ‡¶Æ‡¶æ‡¶∏‡ßá‡¶∞ ‡¶¨‡¶ï‡ßá‡ßü‡¶æ: ${prev} ‡¶ü‡¶æ‡¶ï‡¶æ‡•§ `; if(due > 0) msg += `‡¶è‡¶á ‡¶Æ‡¶æ‡¶∏‡ßá‡¶∞ ‡¶¨‡¶ø‡¶≤: ${due} ‡¶ü‡¶æ‡¶ï‡¶æ‡•§ `;
      if(msg === "") msg = (pay==='Unpaid'?`‡¶¨‡¶ø‡¶≤ ‡¶™‡¶∞‡¶ø‡¶∂‡ßã‡¶ß ‡¶ï‡¶∞‡ßÅ‡¶®‡•§`:`‡¶ß‡¶®‡ßç‡¶Ø‡¶¨‡¶æ‡¶¶!`); else msg += ` ‡¶Æ‡ßã‡¶ü ‡¶™‡¶∞‡¶ø‡¶∂‡ßã‡¶ß ‡¶ï‡¶∞‡ßÅ‡¶®: ${Number(due)+Number(prev)} ‡¶ü‡¶æ‡¶ï‡¶æ‡•§`;
      window.open(`https://wa.me/${n}?text=${encodeURIComponent(msg)}`); 
  }
  function printInvoice(id) {
    const u = users.find(x => x.id == id); if(!u) return;
    $('inv_name').innerText = u.name; $('inv_id').innerText = u.user||'N/A'; $('inv_mob').innerText = u.mob; $('inv_area').innerText = u.area||'N/A';
    $('inv_pkg').innerText = u.pkg; $('inv_date').innerText = getTodayStr(); $('inv_bill').innerText = u.bill + ' Tk'; $('inv_prev').innerText = u.prevDue + ' Tk';
    $('inv_total').innerText = (Number(u.bill)+Number(u.prevDue)) + ' Tk';
    window.print();
  }
  function setFilter(type) { if(currentFilter===type && type!=='all') currentFilter='all'; else currentFilter=type; document.querySelectorAll('.f-item').forEach(b=>b.classList.remove('active')); const m={paid:1,unpaid:2,due:3}; if(m[type]) document.querySelectorAll('.f-item')[m[type]].classList.add('active'); else document.querySelectorAll('.f-item')[0].classList.add('active'); render(); }
  function openExpModal() { if(viewMode)return; $('ex_reason').value=''; $('ex_amount').value=''; renderExpList(); $('expOv').style.display='flex'; }
  function saveExpense() { const r=$('ex_reason').value, a=Number($('ex_amount').value); if(!r||!a) return alert("Enter details"); const d = getTodayStr(), id = Date.now().toString(); expenses.push({id, desc:r, amnt:a, date:d}); enqueue({ type: 'upsertExpense', data: { id, desc:r, amnt:a, date:d } }); saveData(); $('ex_reason').value=''; $('ex_amount').value=''; renderExpList(); }
  function renderExpList() { const l=$('expList'); l.innerHTML=''; [...expenses].reverse().forEach((e,i)=>{ l.innerHTML+=`<div style="border-bottom:1px solid #eee; padding:5px;"><b>${e.desc}</b>: ${e.amnt}tk <small>${e.date}</small> <i class="fas fa-trash" style="color:red;float:right;cursor:pointer;" onclick="delExp(${expenses.length-1-i})"></i></div>`; }); }
  function delExp(i) { if(!viewMode && confirm('Delete?')) { const e = expenses[i]; if(e && e.id) enqueue({ type: 'deleteExpense', id: e.id }); expenses.splice(i,1); saveData(); renderExpList(); } }
  let editId = null;
  function openModal() { if(viewMode)return; editId=null; $('m_name').value=''; $('m_area').value=''; $('m_mob').value=''; $('m_bill').value=''; $('m_user').value=''; $('m_prevDue').value=''; $('m_expDate').value=''; $('modalOv').style.display='flex'; }
  function setBill() { $('m_bill').value = pkgRates[$('m_pkg').value]; }
  function edit(id) { if(viewMode)return; editId=id; const u=users.find(x=>x.id==id); $('m_name').value=u.name; $('m_mob').value=u.mob; $('m_pkg').value=u.pkg; $('m_bill').value=u.bill; $('m_user').value=u.user||''; $('m_area').value=u.area || ''; $('m_prevDue').value = u.prevDue || 0; $('m_expDate').value = u.expDate || ''; $('modalOv').style.display='flex'; }
  function saveUser() { if(viewMode) return; const d = { name: $('m_name').value, mob: $('m_mob').value, pkg: $('m_pkg').value, user: $('m_user').value, bill: Number($('m_bill').value), prevDue: Number($('m_prevDue').value), area: $('m_area').value, expDate: $('m_expDate').value }; if(!d.name) return alert("Name required"); if(editId) { const idx = users.findIndex(x=>x.id==editId); users[idx] = {...users[idx], ...d}; enqueue({ type: 'updateUser', id: editId, data: { name: d.name, mob: d.mob, pkg: d.pkg, user_id: d.user || null, bill: d.bill, prev_due: d.prevDue, area: d.area, exp_date: d.expDate }}); } else { const id = Date.now().toString(); users.unshift({...d, id, conn:'Active', pay:'Unpaid', due:0, prevDue:d.prevDue||0, payDate:null}); enqueue({ type: 'upsertUser', data: { id, name: d.name, mob: d.mob, pkg: d.pkg, user_id: d.user || null, bill: d.bill, conn: 'Active', pay: 'Unpaid', due: 0, prev_due: d.prevDue || 0, pay_date: null, area: d.area, exp_date: d.expDate }}); } $('modalOv').style.display='none'; saveData(); }
  function archiveAndReset() { if(viewMode) return alert("Switch to current month first"); const confirmName = prompt("Start new month? Due will move to 'Prev Due'.\nEnter Name:", $('monthInput').value); if(!confirmName) return; const snapshot = { users: JSON.parse(JSON.stringify(users)), expenses: JSON.parse(JSON.stringify(expenses)) }; const archiveId = Date.now().toString(); archives.push({ id: archiveId, name: confirmName, data: snapshot }); enqueue({ type: 'upsertArchive', data: { id: archiveId, name: confirmName, data: snapshot } }); users.forEach(u => { if(u.conn !== 'Free') { const oldPrev = Number(u.prevDue)||0, currentDue = Number(u.due)||0; u.prevDue = oldPrev + currentDue; u.conn = 'Expired'; u.pay = 'Unpaid'; u.payDate = null; u.due = 0; enqueue({ type: 'updateUser', id: u.id, data: { prev_due: u.prevDue, conn: 'Expired', pay: 'Unpaid', pay_date: null, due: 0 } }); } }); expenses = []; saveData(); alert("New Month Started!"); }
  function handleMonthChange(val) { if(!val) return; if(val === currentActiveMonthStr) { viewMode = false; $('viewStatus').innerText = "‚ö° Live Data (Auto Sync On)"; $('viewStatus').style.background = "#f0fdf4"; $('viewStatus').style.color = "#16a34a"; fetchData(); return; } const arc = archives.find(a => a.name === val); if(arc) { viewMode = true; $('viewStatus').innerText = "üîí Viewing History: " + val; $('viewStatus').style.background = "#fffbeb"; $('viewStatus').style.color = "#d97706"; users = arc.data.users; expenses = arc.data.expenses; render(); } else { alert("No data for " + val); } }
  window.addEventListener('online', flushSyncQueue);
  $('search').addEventListener('input', render);
  init();
</script>
</body>
</html>
